<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Report Lost / Found Item — MW Lost & Found</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* Small custom polish */
    body { background-color: #010c18; color: #e6eef6; }
    .card { background: linear-gradient(180deg, rgba(26,32,44,0.9), rgba(15,23,42,0.95)); border-radius: 14px; box-shadow: 0 10px 30px rgba(2,6,23,0.6); }
    .input { background-color: #0f172a; color: #e6eef6; border: 1px solid rgba(148,163,184,0.06); }
    .input:focus { outline: none; box-shadow: 0 0 0 4px rgba(37,99,235,0.08); border-color: rgba(37,99,235,0.5); }
    .muted { color: #9ca3af; }
    .required-dot::after { content: "*"; color: #ef4444; margin-left: 6px; font-weight: 600; font-size: 0.95em; }
    .preview-img { max-height: 220px; object-fit: cover; border-radius: 8px; display:block; }
    @media (max-width: 640px) {
      .form-grid { grid-template-columns: 1fr; }
      .form-container { margin: 1.5rem; padding: 1.25rem; }
    }
  </style>
</head>

<body class="antialiased">

  <!-- NAVBAR -->
  <header id="navbar" class="fixed top-0 left-0 w-full z-50 bg-transparent transition-colors duration-300">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
      <a href="index.html" class="text-white text-lg font-semibold">Malawi Lost & Found</a>

      <nav class="hidden md:flex gap-6 text-sm">
        <a href="index.html" class="text-slate-200 hover:text-white">Home</a>
        <a href="browse.html" class="text-slate-200 hover:text-white">Browse</a>
        <a href="search.html" class="text-slate-200 hover:text-white">Search</a>
        <a href="admin-login.html" class="text-red-400 hover:text-red-300">Admin</a>
      </nav>

      <!-- mobile menu button -->
      <div class="md:hidden">
        <button id="mobileMenuBtn" aria-label="Open menu" class="p-2">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#e6eef6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12h18M3 6h18M3 18h18"/></svg>
        </button>
      </div>
    </div>
    <!-- mobile menu -->
    <div id="mobileMenu" class="hidden bg-[#07101a]">
      <div class="px-4 py-3 flex flex-col gap-2">
        <a href="index.html" class="text-slate-200">Home</a>
        <a href="browse.html" class="text-slate-200">Browse</a>
        <a href="search.html" class="text-slate-200">Search</a>
        <a href="admin-login.html" class="text-red-400">Admin</a>
      </div>
    </div>
  </header>

  <script>
    const navbar = document.getElementById('navbar');

    window.addEventListener('scroll', () => {
      if (window.scrollY > 50) {
        navbar.classList.add('bg-[#010c18]', 'shadow-lg', 'backdrop-blur-md');
      } else {
        navbar.classList.remove('bg-[#010c18]', 'shadow-lg', 'backdrop-blur-md');
      }
    });

  </script>
  

  <!-- PAGE CONTENT -->
  <main class="min-h-screen pt-24 pb-12">
    <div class="max-w-6xl mx-auto px-4">

      <!-- Page header -->
      <section class="mb-8 text-center">
        <h1 class="text-3xl md:text-4xl font-extrabold text-white">Report Lost / Found Item</h1>
        <p class="mt-2 muted max-w-2xl mx-auto">Create a clear listing so others can help. Payment information and boosting options are explained in the "How to Use" section.</p>
      </section>

      <!-- Form card -->
      <section class="card form-container p-8 md:p-10">
        <form id="postForm" enctype="multipart/form-data" novalidate>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 form-grid">

            <!-- Left column: main inputs -->
            <div class="md:col-span-2 space-y-4">
              <div>
                <label for="type" class="block text-sm font-medium">Type <span class="muted text-xs"> (Lost / Found)</span></label>
                <select id="type" name="type" class="input w-full rounded-md py-2 px-3" required>
                  <option value="">Select type</option>
                  <option value="Lost">Lost</option>
                  <option value="Found">Found</option>
                </select>
              </div>

              <div>
                <label for="title" class="block text-sm font-medium required-dot">Title</label>
                <input id="title" name="title" type="text" class="input w-full rounded-md py-2 px-3" placeholder="e.g., Black wallet, Silver Toyota keys" required />
              </div>

              <div>
                <label for="description" class="block text-sm font-medium required-dot">Description</label>
                <textarea id="description" name="description" rows="4" class="input w-full rounded-md py-2 px-3" placeholder="Add details: distinguishing marks, brand, where lost/found..." required></textarea>
              </div>

              <div class="grid md:grid-cols-2 gap-4">
                <div>
                  <label for="district" class="block text-sm font-medium required-dot">District</label>
                  <input id="district" name="district" type="text" class="input w-full rounded-md py-2 px-3" placeholder="Blantyre" required />
                </div>
                <div>
                  <label for="area" class="block text-sm font-medium required-dot">Area</label>
                  <input id="area" name="area" type="text" class="input w-full rounded-md py-2 px-3" placeholder="e.g., Limbe" required />
                </div>
              </div>

              <div class="grid md:grid-cols-2 gap-4">
                <div>
                  <label for="lastSeen" class="block text-sm font-medium">Last seen (location)</label>
                  <input id="lastSeen" name="last_seen" type="text" class="input w-full rounded-md py-2 px-3" placeholder="Optional — e.g., Near bus stop" />
                </div>
                <div>
                  <label for="dateLost" class="block text-sm font-medium">Date lost / found</label>
                  <input id="dateLost" name="date_lost" type="date" class="input w-full rounded-md py-2 px-3" />
                </div>
              </div>

              <div>
                <label for="phone" class="block text-sm font-medium required-dot">WhatsApp phone number</label>
                <input id="phone" name="phone_number" type="tel" class="input w-full rounded-md py-2 px-3" placeholder="+265 88X XXX XXX" required />
                <p class="muted text-xs mt-1">We use WhatsApp links for contact. Include country code.</p>
              </div>
            </div>

            <!-- Right column: media and payment -->
            <aside class="space-y-4">
              <!-- Item image (optional) -->
              <div>
                <div class="flex items-center justify-between">
                  <label class="text-sm font-medium">Item image (optional)</label>
                  <span class="muted text-xs">PNG / JPG</span>
                </div>
                <input id="image" name="image" type="file" accept="image/*" class="mt-2 w-full text-sm" />
                <div id="imagePreviewWrap" class="mt-3 hidden">
                  <img id="imagePreview" class="preview-img w-full rounded-md" alt="Item preview" />
                </div>
              </div>

              <!-- Post category / paid option -->
              <div>
                <label for="package" class="block text-sm font-medium">Promotion package</label>
                <select id="package" name="package" class="input w-full rounded-md py-2 px-3">
                  <option value="free" selected>Free — single post</option>
                  <option value="basic">Basic — MWK 5,000</option>
                  <option value="premium">Premium — MWK 10,000</option>
                </select>

                <p id="paymentNote" class="muted text-xs mt-2">For payment details see <a href="index.html#how-to-use" class="text-sky-400 hover:underline">How to Use → Payments</a>.</p>
              </div>

              <!-- Payment screenshot (only for paid packages) -->
              <div id="paymentBlock" class="hidden">
                <div class="flex items-center justify-between">
                  <label class="block text-sm font-medium required-dot">Payment screenshot (required)</label>
                  <span class="muted text-xs">PNG / JPG only</span>
                </div>

                <input id="paymentScreenshot" name="payment_screenshot" type="file" accept="image/*" class="mt-2 w-full text-sm" />
                <div id="paymentPreviewWrap" class="mt-3 hidden">
                  <img id="paymentPreview" class="preview-img w-full rounded-md" alt="Payment preview" />
                </div>
                <p class="muted text-xs mt-2">We will verify payment before promoting your post.</p>
              </div>

              <!-- Status (hidden) - default missing -->
              <input type="hidden" name="status" value="missing" />

              <!-- Submit -->
              <div class="pt-4">
                <button id="submitBtn" type="submit" class="w-full bg-sky-600 hover:bg-sky-700 text-white font-semibold py-2 px-4 rounded-md">Submit Report</button>
                <p id="formMsg" class="mt-3 text-sm"></p>
              </div>
            </aside>
          </div>
        </form>
      </section>

    </div>
  </main>

  <script>
    // Mobile menu toggle
    document.getElementById('mobileMenuBtn').addEventListener('click', () => {
      const m = document.getElementById('mobileMenu');
      m.classList.toggle('hidden');
    });

    // Elements
    const packageSelect = document.getElementById('package');
    const paymentBlock = document.getElementById('paymentBlock');
    const paymentInput = document.getElementById('paymentScreenshot');
    const paymentPreviewWrap = document.getElementById('paymentPreviewWrap');
    const paymentPreview = document.getElementById('paymentPreview');

    const imageInput = document.getElementById('image');
    const imagePreviewWrap = document.getElementById('imagePreviewWrap');
    const imagePreview = document.getElementById('imagePreview');

    const postForm = document.getElementById('postForm');
    const formMsg = document.getElementById('formMsg');

    // Toggle payment screenshot field depending on package
    packageSelect.addEventListener('change', () => {
      const val = packageSelect.value;
      if (val === 'free') {
        paymentBlock.classList.add('hidden');
        paymentInput.removeAttribute('required');
      } else {
        paymentBlock.classList.remove('hidden');
        paymentInput.setAttribute('required', 'required');
      }
    });

    // Preview handlers
    function handleFilePreview(inputEl, previewWrap, previewEl) {
      inputEl.addEventListener('change', () => {
        const file = inputEl.files && inputEl.files[0];
        if (!file) {
          previewWrap.classList.add('hidden');
          previewEl.src = '';
          return;
        }
        // quick type check (images only)
        if (!file.type.startsWith('image/')) {
          alert('Only image files are supported for this upload.');
          inputEl.value = '';
          previewWrap.classList.add('hidden');
          previewEl.src = '';
          return;
        }
        previewEl.src = URL.createObjectURL(file);
        previewWrap.classList.remove('hidden');
      });
    }

    handleFilePreview(imageInput, imagePreviewWrap, imagePreview);
    handleFilePreview(paymentInput, paymentPreviewWrap, paymentPreview);

    // Client-side form submission
    postForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      formMsg.textContent = '';
      formMsg.className = '';

      // Basic validation (HTML5 required handles most, but extra checks)
      const requiredFields = [
        { id: 'type', name: 'Type' },
        { id: 'title', name: 'Title' },
        { id: 'description', name: 'Description' },
        { id: 'district', name: 'District' },
        { id: 'area', name: 'Area' },
        { id: 'phone', name: 'Phone' }
      ];

      for (const f of requiredFields) {
        const el = document.getElementById(f.id);
        if (!el || !el.value.trim()) {
          formMsg.textContent = `${f.name} is required.`;
          formMsg.className = 'text-red-400 mt-2';
          el && el.focus();
          return;
        }
      }

      // If paid package ensure a payment screenshot is provided
      const pkg = packageSelect.value;
      if (pkg !== 'free') {
        if (!paymentInput.files || !paymentInput.files[0]) {
          formMsg.textContent = 'Please upload a payment screenshot for paid promotions.';
          formMsg.className = 'text-red-400 mt-2';
          paymentInput.focus();
          return;
        }
      }

      // Build FormData
      const fd = new FormData();
      fd.append('type', document.getElementById('type').value);
      fd.append('title', document.getElementById('title').value.trim());
      fd.append('description', document.getElementById('description').value.trim());
      fd.append('district', document.getElementById('district').value.trim());
      fd.append('area', document.getElementById('area').value.trim());
      fd.append('last_seen', document.getElementById('lastSeen').value);
      fd.append('date_lost', document.getElementById('dateLost').value || null);
      fd.append('phone_number', document.getElementById('phone').value.trim());
      fd.append('package', packageSelect.value); // free/basic/premium
      // optional item image (only append if provided)
      if (imageInput.files && imageInput.files[0]) fd.append('image', imageInput.files[0]);
      // payment screenshot only appended for paid packages
      if (pkg !== 'free' && paymentInput.files && paymentInput.files[0]) {
        fd.append('payment_screenshot', paymentInput.files[0]);
      }

      // UI: disable button while processing
      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Submitting...';

      try {
        const res = await fetch('http://localhost:5000/api/lost-items', {
          method: 'POST',
          body: fd
        });

        const json = await res.json().catch(() => ({}));

        if (res.ok && json.success !== false) {
          formMsg.textContent = 'Item submitted successfully. Thank you.';
          formMsg.className = 'text-green-400 mt-2';
          postForm.reset();
          imagePreviewWrap.classList.add('hidden');
          paymentPreviewWrap.classList.add('hidden');
          // collapse payment block if necessary
          paymentBlock.classList.add('hidden');
          paymentInput.removeAttribute('required');
        } else {
          // show backend error message if available
          const err = json.error || json.message || 'Submission failed.';
          formMsg.textContent = err;
          formMsg.className = 'text-red-400 mt-2';
        }
      } catch (err) {
        formMsg.textContent = 'Network error: could not reach server.';
        formMsg.className = 'text-red-400 mt-2';
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit Report';
      }
    });

    // Small improvement: hide payment block on load if free selected
    (function init() {
      if (packageSelect.value === 'free') {
        paymentBlock.classList.add('hidden');
      } else {
        paymentBlock.classList.remove('hidden');
      }
    })();
  </script>
</body>
</html>
